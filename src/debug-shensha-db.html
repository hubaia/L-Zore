<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç…æ•°æ®åº“è°ƒè¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .log {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warn { color: #ff9800; }
        .info { color: #2196f3; }
        
        .results {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”® ç¥ç…æ•°æ®åº“è°ƒè¯•å·¥å…·</h1>
        
        <div>
            <button onclick="clearDatabase()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“</button>
            <button onclick="initializeDB()">ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“</button>
            <button onclick="checkDatabase()">ğŸ” æ£€æŸ¥æ•°æ®åº“</button>
            <button onclick="testQuery()">ğŸ¯ æµ‹è¯•æŸ¥è¯¢</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="log" class="log"></div>
        
        <div id="results" class="results" style="display: none;">
            <h3>ğŸ“Š æŸ¥è¯¢ç»“æœ</h3>
            <div id="results-content"></div>
        </div>
    </div>
    
    <script type="module">
        let db = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('results-content');
            
            if (data && data.length > 0) {
                resultsDiv.style.display = 'block';
                contentDiv.innerHTML = data.map(item => 
                    `<div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                        <strong>${item.name}</strong> - ${item.category} - ${item.element} - å¨åŠ›:${item.power}
                    </div>`
                ).join('');
            } else {
                resultsDiv.style.display = 'none';
            }
        }
        
        window.clearDatabase = async function() {
            try {
                log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºæ•°æ®åº“...', 'warn');
                
                // å…³é—­ç°æœ‰è¿æ¥
                if (db) {
                    db.close();
                    db = null;
                }
                
                // åˆ é™¤æ•°æ®åº“
                const deleteRequest = indexedDB.deleteDatabase('L-Zore-Shensha-DB');
                
                deleteRequest.onsuccess = () => {
                    log('âœ… æ•°æ®åº“å·²æ¸…ç©º', 'success');
                };
                
                deleteRequest.onerror = () => {
                    log('âŒ æ¸…ç©ºæ•°æ®åº“å¤±è´¥: ' + deleteRequest.error, 'error');
                };
                
                deleteRequest.onblocked = () => {
                    log('âš ï¸ æ•°æ®åº“æ¸…ç©ºè¢«é˜»å¡ï¼Œè¯·å…³é—­å…¶ä»–æ ‡ç­¾é¡µ', 'warn');
                };
                
            } catch (error) {
                log('âŒ æ¸…ç©ºæ•°æ®åº“å‡ºé”™: ' + error.message, 'error');
            }
        };
        
        window.initializeDB = async function() {
            try {
                log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...', 'info');
                
                const request = indexedDB.open('L-Zore-Shensha-DB', 1);
                
                request.onerror = () => {
                    log('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ' + request.error, 'error');
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                    
                    // è®¾ç½®é”™è¯¯å¤„ç†
                    db.onerror = (event) => {
                        log('âŒ æ•°æ®åº“é”™è¯¯: ' + event.target.error, 'error');
                    };
                };
                
                request.onupgradeneeded = (event) => {
                    log('ğŸ”„ æ•°æ®åº“å‡çº§ä¸­...', 'info');
                    
                    const database = event.target.result;
                    const transaction = event.target.transaction;
                    
                    let store;
                    if (!database.objectStoreNames.contains('shensha')) {
                        log('ğŸ“ åˆ›å»ºç¥ç…å¯¹è±¡å­˜å‚¨...', 'info');
                        store = database.createObjectStore('shensha', { keyPath: 'id' });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('rarity', 'rarity', { unique: false });
                        store.createIndex('element', 'element', { unique: false });
                        store.createIndex('type', 'type', { unique: false });
                        store.createIndex('power', 'power', { unique: false });
                        
                        log('ğŸ’¾ å¼€å§‹å¡«å……æµ‹è¯•æ•°æ®...', 'info');
                        populateTestData(transaction);
                    } else {
                        store = transaction.objectStore('shensha');
                        const countRequest = store.count();
                        countRequest.onsuccess = () => {
                            if (countRequest.result === 0) {
                                log('ğŸ’¾ æ•°æ®åº“ä¸ºç©ºï¼Œå¡«å……æµ‹è¯•æ•°æ®...', 'info');
                                populateTestData(transaction);
                            } else {
                                log(`â„¹ï¸ æ•°æ®åº“å·²åŒ…å« ${countRequest.result} æ¡è®°å½•`, 'info');
                            }
                        };
                    }
                };
                
            } catch (error) {
                log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        function populateTestData(transaction) {
            const store = transaction.objectStore('shensha');
            
            const testData = [
                {
                    id: 'tianyiguiren',
                    name: 'å¤©ä¹™è´µäºº',
                    category: 'å‰æ˜Ÿå‰ç¥',
                    rarity: 'â­â­â­',
                    element: 'é‡‘',
                    power: 4,
                    type: 'auspicious',
                    meaning: 'æœ€é«˜å‰æ˜Ÿï¼Œé¿å…å„è¿',
                    gameEffect: 'ä¿æŠ¤å‹ï¼Œå¯æŠ¤èº«å…ç–«'
                },
                {
                    id: 'wenchang',
                    name: 'æ–‡æ˜Œè´µäºº',
                    category: 'å‰æ˜Ÿå‰ç¥',
                    rarity: 'â­â­',
                    element: 'æ°´',
                    power: 2,
                    type: 'auspicious',
                    meaning: 'èªæ˜æ“…è‰ºï¼Œä¸»å­¦ä¸šåŠŸå',
                    gameEffect: 'æ™ºæ…§å‹ï¼Œæå‡å­¦ä¹ æ•ˆç‡'
                },
                {
                    id: 'yangren',
                    name: 'ç¾Šåˆƒ',
                    category: 'å‡¶æ˜Ÿå‡¶ç¥',
                    rarity: 'â­â­â­',
                    element: 'ç«',
                    power: 3,
                    type: 'inauspicious',
                    meaning: 'åˆšçƒˆå†²åŠ¨ï¼Œæ˜“æƒ¹æ˜¯é',
                    gameEffect: 'ç‹‚æš´æ”»å‡»ï¼Œé«˜å¨åŠ›ä½†æœ‰åå™¬'
                }
            ];
            
            let addedCount = 0;
            testData.forEach(shensha => {
                const request = store.add(shensha);
                request.onsuccess = () => {
                    addedCount++;
                    log(`âœ… æ·»åŠ ç¥ç…: ${shensha.name}`, 'success');
                    if (addedCount === testData.length) {
                        log(`ğŸ‰ æ‰€æœ‰æµ‹è¯•æ•°æ®æ·»åŠ å®Œæˆ (${addedCount}æ¡)`, 'success');
                    }
                };
                request.onerror = () => {
                    log(`âŒ æ·»åŠ ç¥ç…å¤±è´¥: ${shensha.name} - ${request.error}`, 'error');
                };
            });
            
            transaction.oncomplete = () => {
                log('âœ… äº‹åŠ¡å®Œæˆ', 'success');
            };
            
            transaction.onerror = () => {
                log('âŒ äº‹åŠ¡å¤±è´¥: ' + transaction.error, 'error');
            };
        }
        
        window.checkDatabase = async function() {
            if (!db) {
                log('âŒ æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log('ğŸ” æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...', 'info');
                
                const transaction = db.transaction(['shensha'], 'readonly');
                const store = transaction.objectStore('shensha');
                const countRequest = store.count();
                
                countRequest.onsuccess = () => {
                    const count = countRequest.result;
                    log(`ğŸ“Š æ•°æ®åº“åŒ…å« ${count} æ¡ç¥ç…è®°å½•`, 'info');
                    
                    if (count > 0) {
                        // è·å–æ‰€æœ‰æ•°æ®
                        const getAllRequest = store.getAll();
                        getAllRequest.onsuccess = () => {
                            const allData = getAllRequest.result;
                            log(`ğŸ“‹ æˆåŠŸè¯»å–æ‰€æœ‰æ•°æ®`, 'success');
                            showResults(allData);
                            
                            // ç»Ÿè®¡åˆ†ç±»
                            const categories = {};
                            allData.forEach(item => {
                                categories[item.category] = (categories[item.category] || 0) + 1;
                            });
                            
                            Object.entries(categories).forEach(([category, count]) => {
                                log(`   - ${category}: ${count}æ¡`, 'info');
                            });
                        };
                    }
                };
                
                countRequest.onerror = () => {
                    log('âŒ æ£€æŸ¥æ•°æ®åº“å¤±è´¥: ' + countRequest.error, 'error');
                };
                
            } catch (error) {
                log('âŒ æ£€æŸ¥æ•°æ®åº“å‡ºé”™: ' + error.message, 'error');
            }
        };
        
        window.testQuery = async function() {
            if (!db) {
                log('âŒ æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log('ğŸ¯ æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½...', 'info');
                
                const transaction = db.transaction(['shensha'], 'readonly');
                const store = transaction.objectStore('shensha');
                
                // æµ‹è¯•æŒ‰åˆ†ç±»æŸ¥è¯¢
                const categoryIndex = store.index('category');
                const queryRequest = categoryIndex.getAll('å‰æ˜Ÿå‰ç¥');
                
                queryRequest.onsuccess = () => {
                    const results = queryRequest.result;
                    log(`ğŸ” æŸ¥è¯¢'å‰æ˜Ÿå‰ç¥'ç±»åˆ«ï¼Œæ‰¾åˆ° ${results.length} æ¡è®°å½•`, 'success');
                    showResults(results);
                };
                
                queryRequest.onerror = () => {
                    log('âŒ æŸ¥è¯¢å¤±è´¥: ' + queryRequest.error, 'error');
                };
                
            } catch (error) {
                log('âŒ æµ‹è¯•æŸ¥è¯¢å‡ºé”™: ' + error.message, 'error');
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸŒŸ ç¥ç…æ•°æ®åº“è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            log('â„¹ï¸ å»ºè®®æ“ä½œé¡ºåºï¼šæ¸…ç©ºæ•°æ®åº“ â†’ åˆå§‹åŒ–æ•°æ®åº“ â†’ æ£€æŸ¥æ•°æ®åº“ â†’ æµ‹è¯•æŸ¥è¯¢', 'info');
        });
    </script>
</body>
</html> 